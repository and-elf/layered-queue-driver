name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        build_type: [Debug, Release]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
    
    - name: Build
      run: cmake --build build --config ${{ matrix.build_type }}
    
    - name: Run Tests
      working-directory: build
      run: ctest -C ${{ matrix.build_type }} --output-on-failure
  
  coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y lcov
    
    - name: Configure CMake with coverage
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON
    
    - name: Build
      run: cmake --build build
    
    - name: Run Tests
      working-directory: build
      run: ctest --output-on-failure
    
    - name: Generate coverage report
      run: |
        lcov --capture --directory build --output-file coverage.info --rc lcov_branch_coverage=0 --ignore-errors mismatch
        lcov --remove coverage.info '/usr/*' '*/tests/*' '*/googletest/*' '*/build/_deps/*' '*/samples/*' --output-file coverage.info
        lcov --list coverage.info
    
    - name: Generate HTML coverage report
      run: |
        mkdir -p coverage_html
        genhtml coverage.info --output-directory coverage_html --title "Layered Queue Coverage" --legend --show-details
    
    - name: Extract coverage summary
      id: coverage
      run: |
        # Extract overall coverage percentage
        COVERAGE=$(lcov --summary coverage.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
        echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
        
        # Generate detailed summary
        echo "## Code Coverage Report" > coverage_summary.md
        echo "" >> coverage_summary.md
        echo "**Overall Coverage: ${COVERAGE}%**" >> coverage_summary.md
        echo "" >> coverage_summary.md
        echo "### Coverage by File" >> coverage_summary.md
        echo "" >> coverage_summary.md
        echo '```' >> coverage_summary.md
        lcov --list coverage.info >> coverage_summary.md
        echo '```' >> coverage_summary.md
    
    - name: Add coverage to job summary
      run: cat coverage_summary.md >> $GITHUB_STEP_SUMMARY
    
    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const coverage = '${{ steps.coverage.outputs.percentage }}';
          const summary = fs.readFileSync('coverage_summary.md', 'utf8');
          
          // Create or update comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Code Coverage Report')
          );
          
          const commentBody = summary + '\n\n---\n*Updated automatically by GitHub Actions*';
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }
    
    - name: Upload HTML coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage_html/
        retention-days: 30
    
    - name: Coverage badge
      run: |
        COVERAGE=${{ steps.coverage.outputs.percentage }}
        COLOR=red
        if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
          COLOR=green
        elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
          COLOR=yellow
        fi
        
        mkdir -p .github/badges
        echo "![Coverage](https://img.shields.io/badge/coverage-${COVERAGE}%25-${COLOR})" > .github/badges/coverage.md
    
    - name: Check coverage threshold
      run: |
        COVERAGE=${{ steps.coverage.outputs.percentage }}
        THRESHOLD=70
        
        echo "Coverage: ${COVERAGE}%"
        echo "Threshold: ${THRESHOLD}%"
        
        if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo "::warning::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
        else
          echo "::notice::Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"
        fi
