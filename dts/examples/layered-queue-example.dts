/*
 * Copyright (c) 2026 Layered Queue Driver
 * SPDX-License-Identifier: Apache-2.0
 */

/dts-v1/;

/ {
    /* Define queues for data routing */
    q_pressure: lq-queue@0 {
        compatible = "zephyr,lq-queue";
        capacity = <16>;
        drop-policy = "drop-oldest";
        priority = <10>;
    };

    q_state: lq-queue@1 {
        compatible = "zephyr,lq-queue";
        capacity = <8>;
        drop-policy = "drop-newest";
        priority = <5>;
    };

    q_adc_redundant: lq-queue@2 {
        compatible = "zephyr,lq-queue";
        capacity = <16>;
        drop-policy = "drop-oldest";
    };

    q_spi_redundant: lq-queue@3 {
        compatible = "zephyr,lq-queue";
        capacity = <16>;
        drop-policy = "drop-oldest";
    };

    q_merged: lq-queue@4 {
        compatible = "zephyr,lq-queue";
        capacity = <32>;
        drop-policy = "drop-oldest";
        priority = <20>;
    };

    q_safety_switch: lq-queue@5 {
        compatible = "zephyr,lq-queue";
        capacity = <4>;
        drop-policy = "drop-oldest";
        priority = <100>;
    };

    /* ADC pressure sensor source */
    adc_pressure: lq-source@0 {
        compatible = "zephyr,lq-adc-source";
        adc = <&adc1>;
        channel = <2>;
        output-queue = <&q_pressure>;
        poll-interval-ms = <100>;
        averaging = <4>;

        /* Define expected ranges with status codes */
        valid {
            min = <1000>;
            max = <3000>;
            status = <0>;  /* LQ_OK */
        };

        degraded {
            min = <900>;
            max = <3100>;
            status = <1>;  /* LQ_DEGRADED */
        };

        fault {
            min = <0>;
            max = <4095>;
            status = <2>;  /* LQ_OUT_OF_RANGE */
        };
    };

    /* SPI state sensor source */
    spi_state: lq-source@1 {
        compatible = "zephyr,lq-spi-source";
        spi = <&spi2>;
        reg = <0x10>;
        output-queue = <&q_state>;
        poll-interval-ms = <50>;
        read-length = <1>;

        /* Expected value mappings */
        ok {
            value = <0x55>;
            status = <0>;  /* LQ_OK */
        };

        degraded {
            value = <0x5A>;
            status = <1>;  /* LQ_DEGRADED */
        };

        invalid {
            value = <0xFF>;
            status = <3>;  /* LQ_ERROR */
        };
    };

    /* Redundant ADC for critical measurement */
    adc_critical: lq-source@2 {
        compatible = "zephyr,lq-adc-source";
        adc = <&adc1>;
        channel = <3>;
        output-queue = <&q_adc_redundant>;
        poll-interval-ms = <50>;
        averaging = <8>;

        valid {
            min = <1100>;
            max = <2900>;
            status = <0>;
        };

        out_of_range {
            min = <0>;
            max = <4095>;
            status = <2>;
        };
    };

    /* Redundant SPI for critical measurement */
    spi_critical: lq-source@3 {
        compatible = "zephyr,lq-spi-source";
        spi = <&spi2>;
        reg = <0x20>;
        output-queue = <&q_spi_redundant>;
        poll-interval-ms = <50>;
        read-length = <2>;
    };

    /* Merge and vote on redundant inputs */
    merged_input: lq-merge@0 {
        compatible = "zephyr,lq-merge-voter";
        input-queues = <&q_adc_redundant &q_spi_redundant>;
        output-queue = <&q_merged>;
        voting-method = "median";
        tolerance = <50>;
        status-if-violation = <2>;  /* LQ_OUT_OF_RANGE */
        timeout-ms = <200>;

        expected-range {
            min = <1100>;
            max = <2900>;
            status-if-violation = <2>;  /* LQ_OUT_OF_RANGE */
        };
    };

    /* Dual-inverted safety switch input */
    safety_switch: lq-dual-inverted@0 {
        compatible = "zephyr,lq-dual-inverted";
        gpio-normal = <&gpio0 4 0>;
        gpio-inverted = <&gpio0 5 0>;
        output-queue = <&q_safety_switch>;
        poll-interval-ms = <10>;
        debounce-ms = <5>;
        error-on-both-high = true;
        error-on-both-low = true;
        error-status = <3>;  /* LQ_ERROR */
        ok-status = <0>;     /* LQ_OK */
    };
};
