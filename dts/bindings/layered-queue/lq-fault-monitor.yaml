# SPDX-License-Identifier: Apache-2.0
# Fault monitor binding

description: |
  Fault monitor that checks signal conditions and outputs fault flags.
  
  Monitors a single input signal for various fault conditions:
  - Staleness: Signal hasn't updated within timeout
  - Range: Signal value outside min/max bounds  
  - Status: Signal has FAULT or INCONSISTENT status
  
  When any enabled fault condition is detected, sets the fault output
  signal to the configured fault-level, otherwise 0 (OK).
  
  Optionally can trigger limp-home mode by modifying a scale driver's
  parameters when faults are detected. This provides automatic safety
  degradation without requiring external wake callbacks.

compatible: "lq,fault-monitor"

properties:
  input-signal-id:
    type: int
    required: true
    description: Signal ID to monitor

  fault-output-signal-id:
    type: int
    required: true
    description: Signal ID for fault output (0=OK, 1=FAULT)

  check-staleness:
    type: boolean
    description: Enable staleness detection

  stale-timeout-us:
    type: int
    description: Staleness timeout in microseconds

  check-range:
    type: boolean
    description: Enable range checking

  min-value:
    type: int
    description: Minimum valid value

  max-value:
    type: int
    description: Maximum valid value

  check-status:
    type: boolean
    description: Check for FAULT/INCONSISTENT status from merges

  fault-level:
    type: int
    description: |
      Severity level when fault is detected (default: 1)
      0 = No fault (informational)
      1 = Warning / Soft fault
      2 = Error / Medium fault
      3 = Critical / Hard fault
      Higher levels available with LQ_MAX_FAULT_LEVELS config

  wake-function:
    type: string
    description: |
      Name of wake callback function to call when fault state changes.
      User must implement: void function_name(uint8_t monitor_id, 
                                               int32_t input_value, 
                                               enum lq_fault_level level)
      Use this for immediate safety actions (shutdown, limp mode, etc.)

  limp-target-scale-id:
    type: int
    description: |
      Index of scale driver to modify when fault is detected (0-based).
      When specified, enables limp-home mode response. The fault monitor
      will automatically modify this scale driver's parameters when the
      fault is active and restore them when the fault clears.

  limp-scale-factor:
    type: int
    description: |
      Scale factor to use in limp mode (1000 = 1.0x).
      If not specified, normal scale factor is unchanged.
      Use to reduce sensitivity: 500 = half response, 250 = quarter response.

  limp-clamp-max:
    type: int
    description: |
      Maximum output clamp in limp mode.
      If not specified, normal clamp-max is unchanged.
      Use to limit maximum output when faults occur.

  limp-clamp-min:
    type: int
    description: |
      Minimum output clamp in limp mode.
      If not specified, normal clamp-min is unchanged.

  restore-delay-ms:
    type: int
    description: |
      Delay in milliseconds before restoring normal mode after fault
      clears. Prevents oscillation between modes (hysteresis).
      Default: 0 (immediate restore)

  status:
    type: string
    description: "okay" to enable, "disabled" to disable
