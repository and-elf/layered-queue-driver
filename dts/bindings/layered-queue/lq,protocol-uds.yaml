# Copyright (c) 2026 Layered Queue Driver
# SPDX-License-Identifier: Apache-2.0

description: |
  UDS (Unified Diagnostic Services) Protocol Driver - ISO 14229
  
  Implements automotive diagnostic services for ECU diagnostics,
  configuration, and programming.
  
  Supported Services:
  - 0x10: Diagnostic Session Control
  - 0x22: Read Data By Identifier
  - 0x2E: Write Data By Identifier
  - 0x27: Security Access
  - 0x31: Routine Control
  - 0x3E: Tester Present
  
  Features:
  - Multi-level security access with seed/key
  - Session timeout management (S3)
  - Custom DID handlers for application data
  - Negative Response Code (NRC) generation
  
  Typically runs over ISO-TP transport layer.

compatible: "lq,protocol-uds"

properties:
  isotp:
    type: phandle
    required: true
    description: |
      Reference to ISO-TP transport layer node.
      UDS messages are transported over ISO-TP.

  max-security-level:
    type: int
    default: 3
    description: |
      Maximum security level supported (0-3).
      Levels:
      - 0: Locked (no access)
      - 1: Basic access (read-only)
      - 2: Extended access (read/write config)
      - 3: Programming access (flash operations)

  default-session:
    type: int
    default: 1
    description: |
      Default diagnostic session (0x10 service).
      Sessions:
      - 1: Default session
      - 2: Programming session
      - 3: Extended diagnostic session
      - 4: Safety system diagnostic session

  s3-timeout-ms:
    type: int
    default: 5000
    description: |
      S3 server timeout (ms).
      Maximum time between tester present messages before
      returning to default session.
      Standard: 5000ms

  p2-timeout-ms:
    type: int
    default: 50
    description: |
      P2 server timeout (ms).
      Maximum time for server to start response transmission.
      Standard: 50ms

  p2-star-timeout-ms:
    type: int
    default: 5000
    description: |
      P2* enhanced timeout (ms).
      Extended timeout when server sends NRC 0x78 (Pending).
      Standard: 5000ms

  security-lockout-enabled:
    type: boolean
    default: true
    description: |
      Enable security access lockout after failed attempts.
      Prevents brute-force attacks on seed/key algorithm.

  max-security-attempts:
    type: int
    default: 3
    description: |
      Maximum security access attempts before lockout.
      After this many failures, security is locked until
      power cycle or timeout expires.

  security-lockout-time-ms:
    type: int
    default: 60000
    description: |
      Security lockout duration (ms).
      Time before security attempts reset after lockout.
      Standard: 60000ms (1 minute)

  seed-key-algorithm:
    type: string
    enum:
      - "simple-xor"
      - "custom"
    default: "simple-xor"
    description: |
      Seed/key algorithm for security access.
      - simple-xor: key = seed ^ 0xDEADBEEF (testing only!)
      - custom: User-provided callback function
      
      IMPORTANT: simple-xor is NOT secure. Use custom callback
      for production with proper cryptographic algorithm.

  enable-routine-control:
    type: boolean
    default: true
    description: |
      Enable Routine Control service (0x31).
      Required for calibration mode and system tests.

  enable-write-did:
    type: boolean
    default: true
    description: |
      Enable Write Data By Identifier service (0x2E).
      Required for configuration framework.

  enable-read-did:
    type: boolean
    default: true
    description: |
      Enable Read Data By Identifier service (0x22).
      Always enabled for diagnostics.

child-binding:
  description: |
    Data Identifiers (DIDs) for diagnostic data access.
    Each child node defines one or more DIDs.

  properties:
    did:
      type: int
      required: true
      description: |
        Data Identifier (16-bit).
        Standard ranges:
        - 0xF186-0xF19F: Network configuration
        - 0xF1A0-0xF1FF: Application-specific (layered queue config)
        - 0xF100-0xF18F: Vehicle manufacturer specific
        
        Layered Queue DIDs:
        - 0xF1A0: Signal value
        - 0xF1A1: Signal status
        - 0xF1A2: Remap configuration
        - 0xF1A3: Scale configuration
        - 0xF1A6: Calibration mode status

    access:
      type: string
      enum:
        - "read"
        - "write"
        - "read-write"
      default: "read"
      description: |
        DID access permissions.
        - read: Service 0x22 only
        - write: Service 0x2E only
        - read-write: Both services

    security-level:
      type: int
      default: 0
      description: |
        Minimum security level required for access.
        0 = No security needed
        1-3 = Security unlock required

    session-type:
      type: int
      default: 1
      description: |
        Required diagnostic session for access.
        1 = Default session
        3 = Extended diagnostic session

    data-length:
      type: int
      description: |
        Fixed data length for this DID (bytes).
        If omitted, variable length is supported.

    handler:
      type: string
      enum:
        - "config-framework"
        - "custom"
      default: "custom"
      description: |
        DID handler type.
        - config-framework: Uses lq_config DID handlers
        - custom: Application-provided callback
